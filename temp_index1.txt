<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>VR Tour</title>
    <link rel="icon" href="data:," />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

    <style>
      :root{
        --brand-indigo:#1B1756; --brand-yellow:#F3C400;
        --panel:#101226; --panel-2:#20233B; --ink:#E7ECFF;
        /* Minimap base width with responsive clamp (overrides JS default 360px) */
        --mini-width: clamp(160px, 42vw, 320px);
      }
      html,body{height:100%;margin:0;background:#000;color:var(--ink);
        font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu}
      /* Canvas uses progressive fallbacks for older iOS */
      #renderCanvas{
        width:100vw; height:100vh; /* fallback */
        height:100svh;             /* iOS 15+ */
        height:100dvh;             /* modern */
        display:block; touch-action:none
      }
      /* CSS fallback fullscreen (iOS without Fullscreen API, and iframes) */
      body.fakefs { overflow:hidden }
      body.fakefs #renderCanvas{ position:fixed; inset:0; width:100vw; height:100vh; height:100svh; height:100dvh; }

      /* bottom-left bar (reduced opacity) */
      #bottomBar{
        position:fixed; left:max(12px, env(safe-area-inset-left)); bottom:max(12px, env(safe-area-inset-bottom)); z-index:100002;
        display:flex; gap:12px; align-items:center; flex-wrap:wrap;
        background: rgba(16,18,38,.55);
        border: 1px solid rgba(32,35,59,.55);
        border-radius:18px; padding:12px 14px;
        -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
      }
      /* Hide bottom bar unless Guide mode is active */
      body:not([data-role="guide"]) #bottomBar{ display:none !important }
      body.fakefs #bottomBar{ z-index:100002 }

      /* Rotate overlay (phones portrait only) */
      #rotateOverlay{ position:fixed; inset:0; display:none; place-items:center; z-index:100000; background:rgba(0,0,0,.86); color:#fff; text-align:center; padding:24px; }
      #rotateOverlay .card{ background:#0f1424; border:1px solid rgba(32,35,59,.9); border-radius:16px; padding:16px 18px; max-width:min(90vw,520px) }
      #rotateOverlay h2{ margin:0 0 8px; font:700 18px/1.2 Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto }
      #rotateOverlay p{ margin:0; opacity:.9 }

      /* Tap-to-start button for iOS autostart flows */
      #tapStart{ margin-top:12px; display:none; background:#F3C400; color:#1a1a1a; border:0; border-radius:12px; padding:10px 14px; font:700 14px Inter, ui-sans-serif, system-ui; cursor:pointer }

      /* Exit fullscreen button (top-right) */
      #exitFSBtn{ position:fixed; right:max(12px, env(safe-area-inset-right)); top:max(12px, env(safe-area-inset-top)); z-index:100001; display:none; background:rgba(16,18,38,.75); border:1px solid rgba(32,35,59,.9); color:#F3C400; border-radius:10px; padding:8px 10px; cursor:pointer }
      #exitFSBtn:active{ transform:translateY(1px) }

      /* === Custom dropdown (used for both gate + live) === */
      .select{ position:relative; width:auto; }
      .select-btn{
        display:flex; align-items:center; justify-content:space-between; gap:10px;
        min-width:180px; padding:12px 14px; padding-right:42px;
        background:#0f1424; color:var(--ink);
        border:1px solid rgba(32,35,59,.55); border-radius:12px;
        font-size:15px; line-height:1.1; cursor:pointer;
      }
      .select-btn:focus{ outline:none; box-shadow:0 0 0 2px var(--brand-yellow); }
      .select-btn svg{ position:absolute; right:12px; pointer-events:none; transition:transform .18s ease; }
      .select[data-open="true"] .select-btn svg{ transform:rotate(180deg); }

      .select-list{
        position:absolute; bottom:calc(100% + 8px); left:0; right:0;
        background:#0f1424; border:1px solid var(--brand-yellow);
        border-radius:12px; padding:6px 0; margin:0; list-style:none;
        box-shadow:0 10px 24px rgba(0,0,0,.35); display:none; z-index:50;
        max-height:280px; overflow:auto;
      }
      /* drop downward when used inside the gate row */
      .select.drop-down .select-list{ top:calc(100% + 8px); bottom:auto; }
      .select[data-open="true"] .select-list{ display:block; }
      .select-list li{
        padding:12px 14px; font-size:15px; cursor:pointer; color:var(--ink);
      }
      .select-list li:hover,
      .select-list li.active{
        background:var(--brand-yellow); color:#1a1a1a;
      }
      /* hide native selects we sync with */
      #expSelectLive, #expSelect{ display:none; }

      /* D-pad */
      #dpad{
        display:grid;
        grid-template-areas:
          ".   up    ."
          "left .   right"
          ".  down   .";
        grid-template-columns: 42px 42px 42px;
        grid-template-rows: 42px 42px 42px;
        gap:8px;
      }
      #dpad button{
        width:42px; height:42px;
        border:1px solid rgba(32,35,59,.55);
        border-radius:12px; cursor:pointer;
        background: rgba(27,23,86,.65);
        color: var(--brand-yellow);
        font-size:18px; display:grid; place-items:center;
        transition: transform .05s ease, background .15s ease, border-color .15s ease;
      }
      #dpad button:hover{ background: rgba(27,23,86,.8); border-color: var(--brand-yellow) }
      #dpad button:active{ transform: translateY(1px) }
      #btnUp{grid-area:up;} #btnDown{grid-area:down;} #btnLeft{grid-area:left;} #btnRight{grid-area:right;}

      /* minimap (top-right) */
      .mini-wrap{ position:fixed!important; top:12px!important; right:12px!important; left:auto!important }
      .mini-wrap .mini-panel{
        background: rgba(16,18,38,.86)!important; border:1px solid rgba(32,35,59,.9)!important; color:var(--ink)!important;
      }
      .mini-wrap select,.mini-wrap button{ font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu!important }
      .mini-wrap .point{ background: var(--brand-yellow)!important }

      /* logo top-left */
      #brandLogo{
        position:fixed; top:max(12px, env(safe-area-inset-top)); left:max(12px, env(safe-area-inset-left)); z-index:41;
        padding:8px 10px; border-radius:12px;
        background: rgba(0,0,0,.22); opacity:.95;
        -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
        user-select:none; pointer-events:none;
      }
      #brandLogo img{ height:90px; width:auto; display:block; opacity:.85 }

      /* XR/WebXR button: make more transparent */
      .xr-button,
      .xr-button-container button,
      .xr-button-overlay button,
      .webxr-button,
      .babylonVRicon {
        opacity: .5 !important;
        transition: opacity .15s ease;
      }
      .xr-button:hover,
      .xr-button-container button:hover,
      .xr-button-overlay button:hover,
      .webxr-button:hover,
      .babylonVRicon:hover { opacity: .8 !important; }

      /* Join gate overlay */
      #roleGate{ position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
        background: radial-gradient(1000px 600px at 50% 30%, #13152A, #070812); }
      .gate-card{
        width:min(92vw,560px); padding:22px; border-radius:16px;
        background: rgba(16,18,38,.86); color:var(--ink);
        border:1px solid rgba(32,35,59,.9); box-shadow:0 10px 40px rgba(0,0,0,.45);
        font:14px/1.4 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu;
      }
      .gate-row{ display:flex; gap:10px; margin-top:12px; align-items:center; }
      .gate-row input{
        flex:1; background:#0f1424; color:var(--ink); border:1px solid rgba(32,35,59,.9);
        padding:12px 14px; border-radius:12px; outline:none;
      }
      .btn{ background: var(--brand-indigo); color:#fff; border:1px solid rgba(32,35,59,.9);
        border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; }
      .btn.secondary{ background: var(--brand-yellow); color:#1a1a1a; border-color: var(--brand-yellow); }
      .btn:hover{ filter: brightness(1.05); }
      /* Viewer must never see HUD/minimap/mirror */
      body[data-role="viewer"] #bottomBar,
      body[data-role="viewer"] .mini-wrap,
      body[data-role="viewer"] #mirrorHud{ display:none !important }

      /* iOS fullscreen fallback: keep UI visible over canvas */
      body.fakefs { background:#000; overflow:hidden }
      /* Force true fullscreen canvas in CSS fallback */
      body.fakefs #renderCanvas{ position:fixed; inset:0; width:100vw; height:100vh; height:100svh; height:100dvh; z-index:99997 }
      /* SVG sizes */
      #dpad button svg{ width:16px; height:16px; display:block; stroke:currentColor; fill:none }
      /* Simple tooltips using data-tip */
      [data-tip]{ position:relative }
      [data-tip]:hover::after{
        content: attr(data-tip);
        position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%);
        background:#0f1424; color:var(--ink); border:1px solid rgba(32,35,59,.7);
        padding:6px 8px; border-radius:8px; font-size:12px; white-space:nowrap; z-index:60;
        box-shadow:0 6px 16px rgba(0,0,0,.35);
      }
      [data-tip]:hover::before{
        content:""; position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
        border:6px solid transparent; border-top-color:rgba(32,35,59,.7);
        filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));
      }
      /* Circle buttons + zoom column (legacy UI parity) */
      .btn-circle{width:36px;height:36px;border:1px solid rgba(32,35,59,.55);border-radius:10px;cursor:pointer;background:rgba(27,23,86,.65);color:var(--brand-yellow);display:grid;place-items:center;transition:transform .05s ease;font-size:16px}
      .btn-circle:active{ transform: translateY(1px) }
      #zoomWrap{display:flex;flex-direction:column;gap:6px;margin-left:2px}
          /* ==== Mirror HUD (Agent only): invisible container for viewer badges ==== */
      #mirrorHud{
        position:fixed; z-index:39;
        right:max(12px,env(safe-area-inset-right));
        bottom:max(12px,env(safe-area-inset-bottom));
        top:auto; left:auto;
        width:26vw; height:30vh; pointer-events:none;
      }
